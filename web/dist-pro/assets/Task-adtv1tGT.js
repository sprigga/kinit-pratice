var Z=Object.defineProperty;var V=Object.getOwnPropertySymbols;var ee=Object.prototype.hasOwnProperty,ae=Object.prototype.propertyIsEnumerable;var D=(n,o,l)=>o in n?Z(n,o,{enumerable:!0,configurable:!0,writable:!0,value:l}):n[o]=l,F=(n,o)=>{for(var l in o||(o={}))ee.call(o,l)&&D(n,l,o[l]);if(V)for(var l of V(o))ae.call(o,l)&&D(n,l,o[l]);return n};var _=(n,o,l)=>new Promise((x,g)=>{var C=u=>{try{w(l.next(u))}catch(v){g(v)}},A=u=>{try{w(l.throw(u))}catch(v){g(v)}},w=u=>u.done?x(u.value):Promise.resolve(u.value).then(C,A);w((l=l.apply(n,o)).next())});import{a as te,r as le,b as se,d as oe,c as ie,p as re}from"./task-D3LcVQhU.js";import{u as ne,_ as ue}from"./Table.vue_vue_type_script_lang-CinN-tID.js";import{d as pe,q as p}from"./index-C1ugVV0M.js";/* empty css                  *//* empty css               *//* empty css                       *//* empty css                 *//* empty css                   */import{_ as de}from"./Search.vue_vue_type_script_setup_true_lang-BvwzElKB.js";import{_ as me}from"./ContentWrap.vue_vue_type_script_setup_true_lang-DchMNHb7.js";import{_ as ce}from"./Write.vue_vue_type_script_setup_true_lang-Bx2T2EwG.js";import{_ as fe}from"./Dialog.vue_vue_type_style_index_0_lang-B2Mf8MAr.js";import{l as _e,aB as ve,J as O,O as s,P as R,V as d,a as m,m as S,p as ge,R as r,u as a,B as I,W as M,S as N,X as U}from"./vue-chunks-DM5Q6aJS.js";import{_ as we}from"./CronExpression.vue_vue_type_style_index_0_lang-DU7BOGxY.js";import{A as ye,z as ke,b as j,n as be,h as E}from"./element-plus-DaxMU9jX.js";/* empty css                        *//* empty css               */import"./el-tooltip-l0sNRNKZ.js";/* empty css                  */import"./useForm-wf4P-Ogs.js";/* empty css                          *//* empty css                        *//* empty css                       *//* empty css                *//* empty css                   *//* empty css                    */import"./style.css_vue_type_style_index_0_src_true_lang-q8G9uCLO.js";import"./wang-editor-kNnY1XhY.js";/* empty css                   *//* empty css                    *//* empty css                        *//* empty css                *//* empty css                         */import"./_Uint8Array-DKqHwQen.js";import"./useIcon-DYAT9UAl.js";import"./useValidator-CSahUiaF.js";import"./dict-D9K4TqBi.js";import"./dict-C7Zbg3Vq.js";import"./RunDatetimeList-BjBWZNZP.js";import"./CronExample-3y0SSBGS.js";const ua=_e({name:"SystemTask",__name:"Task",setup(n){const{push:o}=ve(),{t:l}=pe(),{tableRegister:x,tableState:g,tableMethods:C}=ne({fetchDataApi:()=>_(this,null,function*(){const{pageSize:t,currentPage:e}=g,i=yield se(F({page:a(e),limit:a(t)},a(P)));return{list:i.data||[],total:i.count||0}}),fetchDelApi:t=>_(this,null,function*(){return(yield oe(t)).code===200})}),{dataList:A,loading:w,total:u,pageSize:v,currentPage:y}=g,{getList:k,delList:q}=C,J=O([{field:"_id",label:"任務編號",show:!0,disabled:!0,width:"230px",span:24},{field:"name",label:"任務名稱",show:!0,disabled:!0,span:24},{field:"group",label:"任務分組",show:!0,span:24},{field:"job_class",label:"調用目標",show:!0,span:24},{field:"exec_strategy",label:"執行策略",show:!0,colProps:{span:24},componentProps:{style:{width:"100%"}}},{field:"expression",label:"表達式",show:!0,span:24},{field:"is_active",label:"任務狀態",show:!0,width:"100px",slots:{default:t=>{const e=t.row;return s(R,null,[s(ye,{modelValue:e.is_active,disabled:!0},null)])}}},{field:"last_run_datetime",label:"最近一次執行時間",show:!0,width:"180px",span:24},{field:"remark",label:"任務備註",show:!0,span:24},{field:"create_datetime",label:"創建時間",show:!0,width:"180px",span:24},{field:"action",label:"操作",show:!0,disabled:!1,width:"240px",slots:{default:t=>{const e=t.row;return s(R,null,[s(p,{type:"primary",link:!0,size:"small",onClick:()=>G(e)},{default:()=>[d("編輯")]}),s(p,{type:"primary",link:!0,size:"small",onClick:()=>L(e)},{default:()=>[d("調度日誌")]}),s(p,{type:"primary",link:!0,size:"small",onClick:()=>Y(e)},{default:()=>[d("執行一次")]}),s(p,{type:"danger",link:!0,size:"small",onClick:()=>X(e)},{default:()=>[d("刪除")]})])}}}]),W=O([{field:"name",label:"任務名稱",component:"Input",componentProps:{clearable:!0,style:{width:"214px"}}},{field:"_id",label:"任務編號",component:"Input",componentProps:{clearable:!0,style:{width:"214px"}}},{field:"group",label:"任務分組",component:"Select",componentProps:{style:{width:"214px"},options:[]}}]),P=m({}),z=t=>{y.value=1,P.value=t,k()},B=m(!1),X=t=>_(this,null,function*(){B.value=!0,yield q(!0,[t._id]).finally(()=>{B.value=!1})}),c=m(!1),b=m(""),h=m(),f=m(""),$=m(),T=m(!1),G=t=>_(this,null,function*(){const e=yield te(t._id);e&&(b.value="編輯定時任務",f.value="edit",h.value=e.data,c.value=!0)}),H=()=>{b.value="新增定時任務",f.value="add",h.value=void 0,c.value=!0},K=()=>_(this,null,function*(){const t=a($),e=yield t==null?void 0:t.submit();if(e){T.value=!0;try{const i=m({});f.value==="add"?(i.value=yield ie(e),i.value&&(c.value=!1,k())):f.value==="edit"&&(i.value=yield re(e._id,e),i.value&&(c.value=!1,k()))}finally{T.value=!1}}}),Q=()=>{b.value="Cron 表達式",f.value="expression",h.value=void 0,c.value=!0},L=t=>{o(t?`/record/task?job_id=${t._id}`:"/record/task")},Y=t=>_(this,null,function*(){ke.confirm("是否確認立即執行一次任務","顯示",{confirmButtonText:l("common.delOk"),cancelButtonText:l("common.delCancel"),type:"warning"}).then(()=>_(this,null,function*(){const e=yield le(t._id);e&&(e.data>0?j.success("任務成功被主機接收！"):j.error("執行失敗，未有主機接收任務，請檢查定時任務序狀態！"))}))});return(t,e)=>(S(),ge(R,null,[s(a(me),null,{default:r(()=>[s(a(de),{schema:W,onReset:z,onSearch:z},null,8,["schema"]),s(a(ue),{"current-page":a(y),"onUpdate:currentPage":e[1]||(e[1]=i=>I(y)?y.value=i:null),"page-size":a(v),"onUpdate:pageSize":e[2]||(e[2]=i=>I(v)?v.value=i:null),showAction:"",columns:J,"default-expand-all":"","node-key":"id",data:a(A),loading:a(w),pagination:{total:a(u)},onRegister:a(x),onRefresh:a(k)},{toolbar:r(()=>[s(a(be),{gutter:10},{default:r(()=>[s(a(E),{span:1.5},{default:r(()=>[s(a(p),{type:"primary",onClick:H},{default:r(()=>[d("新增定時任務")]),_:1})]),_:1}),s(a(E),{span:1.5},{default:r(()=>[s(a(p),{type:"primary",onClick:e[0]||(e[0]=i=>L(null))},{default:r(()=>[d("調度日誌")]),_:1})]),_:1}),s(a(E),{span:1.5},{default:r(()=>[s(a(p),{type:"primary",onClick:Q},{default:r(()=>[d("快速生成 Cron 表達式")]),_:1})]),_:1})]),_:1})]),_:1},8,["current-page","page-size","columns","data","loading","pagination","onRegister","onRefresh"])]),_:1}),s(a(fe),{modelValue:c.value,"onUpdate:modelValue":e[4]||(e[4]=i=>c.value=i),title:b.value,height:680,width:850},{footer:r(()=>[s(a(p),{type:"primary",loading:T.value,onClick:K},{default:r(()=>[d(M(a(l)("exampleDemo.save")),1)]),_:1},8,["loading"]),s(a(p),{onClick:e[3]||(e[3]=i=>c.value=!1)},{default:r(()=>[d(M(a(l)("dialogDemo.close")),1)]),_:1})]),default:r(()=>[f.value==="add"||f.value==="edit"?(S(),N(ce,{key:0,ref_key:"writeRef",ref:$,"current-row":h.value},null,8,["current-row"])):U("",!0),f.value==="expression"?(S(),N(we,{key:1})):U("",!0)]),_:1},8,["modelValue","title"])],64))}});export{ua as default};
